{% extends "base.html" %}

{% block title %}旅行入力フォーム{% endblock %}

{% block content %}
<h2>旅行を登録</h2>
<form method="post" action="{{ url_for('main.edit_travel', travel_id=travel.id) }}">
    <div class="newtravel-container">    
        <label>旅行タイトル <br><input type="text" name="title" value="{{ travel.title }}"></label><br>
        <label>目的地 <br>
            <input type="text" id="autocomplete" placeholder="地名を入力" required>

            <!-- 緯度経度を送る hidden input -->
            <input type="hidden" name="destination" id="destination"  value="{{ travel.destination }}">
            <input type="hidden" name="lat" id="lat" value="{{ travel.latitude }}">
            <input type="hidden" name="lon" id="lon" value="{{ travel.longitude }}">
        </label>
        <label>出発日 <br><input type="date" name="departure_date" value="{{ travel.departure_date }}"></label><br>
        <label>帰着日 <br><input type="date" name="return_date" value="{{ travel.return_date }}"></label><br>
    </div>

    <div class="newtravel-block">
        <label>男性 <input type="number" name="male_count" min="0" value="{{ travel.male_count }}"><span>人</span></label><br>
        <label>女性 <input type="number" name="female_count" min="0" value="{{ travel.female_count }}"><span>人</span></label><br>
        <label>子供 <input type="number" name="child_count" min="0" value="{{ travel.child_count }}"><span>人</span></label><br>    
    </div>

    <div class="newtravel-block">
        <p>交通手段を選択<br></p>
        <div class="transport-options">
            <label><input type="checkbox" name="transport" value="car" {% if 'car' in travel.transport %}checked{% endif %}> 車</label>
            <label><input type="checkbox" name="transport" value="train" {% if 'train' in travel.transport %}checked{% endif %}> 電車</label>
            <label><input type="checkbox" name="transport" value="plane" {% if 'plane' in travel.transport %}checked{% endif %}> 飛行機</label>
            <label><input type="checkbox" name="transport" value="ship" {% if 'ship' in travel.transport %}checked{% endif %}> 船</label>
            <label><input type="checkbox" name="transport" value="bus" {% if 'bus' in travel.transport %}checked{% endif %}> バス</label>
        </div>
    </div>

    <div class="button-area1">
        <button type="submit" class="btn">目的を編集</button>
        <a href="{{ url_for('main.travels_list') }}" class="btn">戻る</a>
    </div>
</form>

<script
src="https://maps.googleapis.com/maps/api/js?key={{ config.GOOGLE_MAPS_API_KEY }}&libraries=places&callback=initAutocomplete"
async defer>
</script>

<script>
    let autocomplete;

    function initAutocomplete() {
        const input = document.getElementById("autocomplete");
        const destInput = document.getElementById("destination");
        const latInput = document.getElementById("lat");
        const lonInput = document.getElementById("lon");
        autocomplete = new google.maps.places.Autocomplete(input, {
            types: ['(cities)'],
            componentRestrictions: { country: 'jp' }
        });

        autocomplete.addListener('place_changed', function () {
            const place = autocomplete.getPlace();
            if (!place.geometry) {
                alert("候補から選んでください");
                // hiddenを空にしてsubmitできないようにする
                destInput.value = "";
                latInput.value = "";
                lonInput.value = "";
                return;
            }

            destInput.value = place.name;
            latInput.value = place.geometry.location.lat();
            lonInput.value = place.geometry.location.lng();
        });

        // 編集画面で hidden に値が入っている場合、input に反映
        if (destInput.value && latInput.value && lonInput.value) {
            input.value = destInput.value;
        } 

        document.querySelector("form").addEventListener("submit", function(e) {
            if (!destInput.value || input.value !== destInput.value) {
                e.preventDefault();
                alert("必ずGoogleマップの候補から目的地を選択してください");
            }
        });
    }
</script>

{% endblock %}
