{% extends "base.html" %}
{% block title %}旅行目的の選択{% endblock %}

{% block content %}
<h2>旅行の目的を選択してください</h2>
<form method="POST" action="{{ url_for('main.select_purpose', travel_id=travel.id) }}">
    <div class="purpose-section"></div>
        {% for category, purposes in grouped_purposes.items() %}
            <h3>{{ category }}</h3>
            <div class="purpose-grid">
                {% for purpose in purposes %}
                    <div class="purpose-card" data-id="{{ purpose.id }}" data-value="{{ purpose.name }}">
                        {{ purpose.name }}
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    </div>

  <input type="hidden" name="purposes" id="selected-purposes">
  <button type="submit" class="submit-btn">持ち物リスト生成</button>
</form>

<script>
  const cards = document.querySelectorAll('.purpose-card');
  const input = document.getElementById('selected-purposes');
  const preSelected = {{ pre_selected_purposes | tojson }}; 
  const selected = new Set(preSelected.map(String));

  // 初期状態でカードに selected クラスをつける
  cards.forEach(card => {
    const id = card.dataset.id;
    if (selected.has(id)) {
      card.classList.add('selected');
    }

      card.addEventListener('click', () => {
        const id = card.dataset.id;
        if (selected.has(id)) {
          selected.delete(id);
          card.classList.remove('selected');
        } else {
          selected.add(id);
          card.classList.add('selected');
        }
        input.value = Array.from(selected).join(',');
      });
  });

  // ページロード時に hidden に初期値をセット
  input.value = Array.from(selected).join(',');

</script>

{% endblock %}