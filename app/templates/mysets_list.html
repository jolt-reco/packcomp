{% extends "base.html" %}

{% block title %}マイセット一覧{% endblock %}

{% block content %}
<h2>マイセット一覧</h2>

<div class="back-btn">
    <div class="button-area1">
        <a href="{{ url_for('main.items', travel_id=travel.id) }}">持ち物リストへ戻る</a>
    </div>
</div>

<div id="myset-container">
    {% for ms in mysets %}
        <div class="myset-block" data-myset-id="{{ ms.id }}">
            <div class="myset-content">
                <!-- 固定ヘッダー -->
                <div class="myset-header">
                    <h3 class="myset-title">{{ ms.name }}</h3>

                    <button class="toggle-items-btn" type="button">▼</button>
                    
                    <form method="POST" action="{{ url_for('main.add_myset_to_travel', my_set_id=ms.id, travel_id=travel.id) }}" class="apply-form">
                        <div class="button-area1">
                            <button type="submit">このマイセットを追加</button>
                        </div>
                    </form>

                    <a href="{{ url_for('main.edit_myset', my_set_id=ms.id, travel_id=travel.id) }}" class="edit-myset-btn">
                        <i data-lucide="pencil"></i>
                    </a>

                    <div class="delete-myset-btn">
                        <i data-lucide="trash-2"></i>
                    </div>
                </div>

                <div class="myset-items hidden"></div>
            </div>
        </div>
    {% else %}
        <p>まだマイセットはありません。</p>
    {% endfor %}
</div>

<script>
document.querySelectorAll(".myset-block").forEach(block => {
    const toggleBtn = block.querySelector(".toggle-items-btn");
    const title = block.querySelector(".myset-title");
    const itemsBox = block.querySelector(".myset-items");
    const deleteBtn = block.querySelector(".delete-myset-btn");
    const mysetId = block.dataset.mysetId;

    toggleBtn.addEventListener("click", () => {
        // すでに開いていたら閉じる
        if (!itemsBox.classList.contains("hidden")) {
            itemsBox.classList.add("hidden");
            itemsBox.innerHTML = "";
            return;
        }

        // Ajax で中身取得
        fetch(`/myset/${mysetId}/items`)
            .then(res => res.json())
            .then(data => {
                const items = data.items;

                if(items.length === 0){
                    itemsBox.innerHTML = "<p>中身は空です</p>";
                } else {
                    itemsBox.innerHTML = items.map(i => `
                        <div class="item-line">
                            ${i.name}（${i.category}）
                        </div>
                    `).join("");
                }

                itemsBox.classList.remove("hidden");
            })
            .catch(() => {
                alert("読み込みエラー");
            });
    });

    deleteBtn.addEventListener("click", () => {
        if(!confirm("このマイセットを本当に削除しますか？")) return;

        fetch(`/myset/${mysetId}/delete`, {
            method: "POST",
        })
        .then(res => {
            if(res.ok){
                block.remove();  // 削除成功したら DOM から消す
            } else {
                alert("削除に失敗しました");
            }
        })
        .catch(() => alert("通信エラー"));
    });
});
</script>

{% endblock %}
