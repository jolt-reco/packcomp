{% extends "base.html" %}

{% block title %}持ち物リスト{% endblock %}

{% block content %}
<h2>{{ travel.title }}（{{ travel.destination }}）の持ち物リスト</h2>

<form method="POST" action="{{ url_for('main.update_quantities', travel_id=travel.id) }}">
    <div class="items-grid">
        {% for category, items in items_category.items() %}
            <h3>{{ category }}</h3>
            <div class="item-container">
                {% for ti in items %}
                    <div class="item-card" data-travel-id="{{ travel.id }}" data-item-id="{{ ti.id }}">
                        <input type="checkbox" class="select-for-myset" value="{{ ti.id }}">
                        <div class="item-name">{{ ti.name }}</div>

                        <div class="qty-control">
                            <div class="down">-</div>
                            <input type="number" class="qty" value="{{ ti.quantity }}" name="qty_{{ ti.id }}" min="1" required>
                            <div class="up">+</div>
                        </div>

                        <button type="button" class="delete-btn">削除</button>
                    </div>
                {% endfor %}
            </div>    
        {% endfor %}
    </div>
    <button type="submit">数量を更新</button>
</form>

<button type="button" id="register-myset-mode" class="mode-off">マイセットに登録</button>
<button type="button" id="submit-myset-btn" class="hidden">選択したアイテムを登録</button>

<a href="{{ url_for('main.travels_list') }}">戻る</a>
<a href="{{ url_for('main.custom_items_list', travel_id=travel.id) }}">アイテムを追加</a>
<a href="{{ url_for('main.mysets_list', travel_id=travel.id) }}">マイセットを表示</a>


<form method="POST" action="{{ url_for('main.reset_items', travel_id=travel.id) }}">
    <button type="submit">リストを再生成</button>
</form>

<div id="overlay" class="overlay hidden"></div>


<script>
    document.querySelectorAll(".item-card").forEach(row => {
        const down = row.querySelector(".down");
        const up = row.querySelector(".up");
        const qty = row.querySelector(".qty");
        const deleteBtn = row.querySelector(".delete-btn");
        const travelId = row.dataset.travelId;
        const itemId = row.dataset.itemId;

        down.addEventListener("click", () => {
            const v = parseInt(qty.value);
            if (v > 1) qty.value = v - 1;
        });

        up.addEventListener("click", () => {
            qty.value = parseInt(qty.value) + 1;
        });

        deleteBtn.addEventListener("click", () => {
            if(!confirm("本当に削除しますか？")) return;

        fetch(`/list/${travelId}/delete/${itemId}`, {
            method: "POST",
        })
        .then(res => {
            if(res.ok) {
                row.remove(); // 削除成功したらDOMから消す
            } else {
                alert("削除できませんでした");
            }
        })
        .catch(() => alert("通信エラー"));
        })
    });


    let mysetMode = false;
    const modeBtn = document.getElementById("register-myset-mode");
    const submitBtn = document.getElementById("submit-myset-btn");
    const cards = document.querySelectorAll(".item-card");
    const overlay = document.getElementById("overlay");

    modeBtn.addEventListener("click", () => {
        mysetMode = !mysetMode
        modeBtn.classList.toggle("mode-on", mysetMode);
        modeBtn.classList.toggle("mode-off", !mysetMode);

        submitBtn.classList.toggle("hidden", !mysetMode);

        overlay.classList.toggle("hidden", !mysetMode);

        // カード見た目切り替え
        cards.forEach(card => {
            card.classList.toggle("mode-on", mysetMode);

            // OFFになったら選択解除
            if (!mysetMode) {
                card.classList.remove("selected");
                card.querySelector(".select-for-myset").checked = false;
            }
        });
    });

    // ▼ カードクリックで選択トグル
    cards.forEach(card => {
        card.addEventListener("click", () => {
            if (!mysetMode) return;
            card.classList.toggle("selected");

            // 対応するチェックボックスも更新
            const checkbox = card.querySelector(".select-for-myset");
            checkbox.checked = card.classList.contains("selected");
        });
    });

    submitBtn.addEventListener("click", () => {
        const selectedIds = [...document.querySelectorAll(".select-for-myset:checked")].map(input => input.value);

        if(selectedIds.length === 0){
            alert("アイテムを選択してください");
            return;
        }

        const mysetName = prompt("マイセット名を入力してください");
        if(!mysetName) return;

        fetch("/myset/create", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                name: mysetName,
                item_ids: selectedIds,
                travel_id: {{ travel.id }}
            })
        })
        .then(res => {
            if(res.ok){
                alert("マイセットに登録しました");
                // チェックをリセット
                location.reload();
            } else {
                alert("登録に失敗しました");
            }
        })
        .catch(() => alert("通信エラー"));
    });
</script>

{% endblock %}