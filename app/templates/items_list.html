{% extends "base.html" %}

{% block title %}持ち物リスト{% endblock %}

{% block content %}
<h2>{{ travel.title }}（{{ travel.destination }}）</h2>

<!-- 進捗ゲージ -->
<p id="progress-text">0%</p>
<div id="progress-bar">
    <div id="progress-fill" style="width:0%"></div>
</div>

<!-- 天気情報 -->
<div class="weather-acquisition">
    <form method="POST" action="{{ url_for('main.travel_weather', travel_id=travel.id) }}">
    <div class="button-area1">
        <button type="submit" class="btn btn-primary">
            天気情報を取得
        </button>
    </div>
    {% if travel.weather_last_update %}
        <small>最終取得: {{ travel.weather_last_update.strftime('%Y-%m-%d %H:%M') }}</small>
    {% endif %}
    </form>
</div>

{% if travel.weather_data %}
<div class="weather-scroll">
    <div class="weather-box">
        {% for day in travel.weather_data %}
        <div class="weather-card">
            <p class="weather-date">{{ day.date[5:].replace('-', '/') }}</p>
            <p class="weather-icon"><i data-lucide="{{ day.weather.icon }}"></i></p>
            <p class="weather-temp">
                <span class="temp-max">{{ day.temp_max }}℃ </span>| 
                <span class="temp-min">{{ day.temp_min }}℃</span>
            </p>
        </div>
        {% endfor %}
    </div>
</div>

{% else %}
  <p>天気情報は取得されていません</p>
{% endif %}

<!-- 天気アイテムモーダル表示ボタン -->
<div class="button-area1">
    <button id="openWeatherModal" class="btn btn-secondary">
    天気に合ったアイテムを追加する
    </button>
</div>


<!-- 天気アイテムモーダル -->
<div id="weatherModal" class="modal-overlay hidden">
    <div id="weatherModalBackdrop" class="modal-backdrop"></div>

    <div class="modal-content">

        <button type="button" id="closeWeatherModal" class="modal-close">✕</button>

        <form method="POST" action="{{ url_for('main.auto_items_post', travel_id=travel.id) }}">
            {% include "_candidate_items.html" %}
            <div class="button-area1">
                <button type="submit" class="btn btn-primary">追加する</button>
            </div>
        </form>
    </div>
</div>

<form id="qty-form" method="POST" action="{{ url_for('main.update_quantities', travel_id=travel.id) }}">
    <div class="items-grid">
        {% for category in category_order %}
            {% set items = items_category.get(category, []) %}
            {% if items %}
                <div class="category-block">
                    <h3>{{ category }}</h3>
                    <div class="item-container">
                        {% for ti in items %}
                            <div class="item-card" data-travel-id="{{ travel.id }}" data-item-id="{{ ti.id }}">
                                <input type="checkbox" class="select-for-myset" value="{{ ti.id }}">
                                <div class="progress-control">
                                    <input type="checkbox" class="progress-checkbox" {% if ti.checked %}checked{% endif %}>
                                </div>
                                <div class="item-name">{{ ti.name }}</div>

                                <div class="qty-control">
                                    <div class="down">-</div>
                                    <input type="number" class="qty" value="{{ ti.quantity }}" name="qty_{{ ti.id }}" min="1" required>
                                    <div class="up">+</div>
                                </div>

                                <button type="button" class="delete-btn">削除</button>
                            </div>
                        {% endfor %}
                    </div>
                </div> 
            {% endif %}   
        {% endfor %}
    </div>
</form>

<div class="side-actions">
    <button type="button" id="register-myset-mode" class="mode-off" data-label="マイセットに登録">
        <i data-lucide="file-pen"></i>
    </button>

    <button type="button" id="submit-myset-btn" class="hidden" data-label="選択したアイテムを登録">
        <i data-lucide="clipboard-check"></i>
    </button>

    <a id="btn-show-mysets" href="{{ url_for('main.mysets_list', travel_id=travel.id) }}" data-label="マイセットを表示">
        <i data-lucide="monitor"></i>
    </a>

    <button type="button" id="btn-update-qty" data-label="数量を更新">
        <i data-lucide="refresh-ccw"></i>
    </button>

    <a id="btn-add-custom-item" href="{{ url_for('main.custom_items_list', travel_id=travel.id) }}" data-label="アイテムを追加">
        <i data-lucide="circle-plus"></i>
    </a>

    <form method="POST" action="{{ url_for('main.reset_items', travel_id=travel.id) }}">
        <button id="btn-reset-items" type="submit" data-label="リストを再生成">
            <i data-lucide="rotate-ccw"></i>
        </button>
    </form>
    
    <a id="btn-back" href="{{ url_for('main.travels_list') }}" data-label="戻る">
        <i data-lucide="undo-2"></i>
    </a>
</div>

<div id="overlay" class="overlay hidden"></div>


<script>

    // 数量変更フォーム送信
    document.getElementById("btn-update-qty").addEventListener("click", () => {
        document.getElementById("qty-form").submit();
    });

    // 天気情報取得→weather_itemsの処理順でモーダルを開く
    document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById("weatherModal");
        const openBtn = document.getElementById("openWeatherModal");
        const closeBtn = document.getElementById("closeWeatherModal");
        const backdrop = document.getElementById("weatherModalBackdrop");

        // ボタンでモーダル開け
        if (openBtn) {
            openBtn.addEventListener("click", () => {
                modal.classList.remove("hidden");
            });
        }

        // weather_items に遷移してモーダル開け
        {% if request.endpoint == "main.weather_items" %}
            modal.classList.remove("hidden");
        {% endif %}

        // ボタンでモーダル閉じ
        if (closeBtn) {
            closeBtn.addEventListener("click", () => {
                modal.classList.add("hidden");
            });
        }

        // 背景クリックでモーダル閉じ
        if (backdrop) {
            backdrop.addEventListener("click", () => {
                modal.classList.add("hidden");
            });
        }
    
    });


    document.addEventListener("DOMContentLoaded", () => {
        if (window.lucide) {
            lucide.replace();  // <i> を SVG に置換
        }
    });

    function updateProgress() {
        const checkboxes = document.querySelectorAll(".progress-checkbox");
        const total = checkboxes.length;
        const checked = [...checkboxes].filter(cb => cb.checked).length;
        const percent = checked === total ? 100 : Math.floor(checked / total * 100);
        document.getElementById("progress-fill").style.width = percent + "%";
        document.getElementById("progress-text").textContent = percent + "%";
    }

    // 初期読み込み時に進捗反映
    updateProgress();

    // チェックボックス変更時
    document.querySelectorAll(".progress-checkbox").forEach(cb => {
        cb.addEventListener("change", updateProgress);
    });

    document.querySelectorAll(".item-card").forEach(row => {
        const down = row.querySelector(".down");
        const up = row.querySelector(".up");
        const qty = row.querySelector(".qty");
        const deleteBtn = row.querySelector(".delete-btn");
        const travelId = row.dataset.travelId;
        const itemId = row.dataset.itemId;

        down.addEventListener("click", () => {
            const v = parseInt(qty.value);
            if (v > 1) qty.value = v - 1;
        });

        up.addEventListener("click", () => {
            qty.value = parseInt(qty.value) + 1;
        });

        deleteBtn.addEventListener("click", () => {
            if(!confirm("本当に削除しますか？")) return;

        fetch(`/list/${travelId}/delete/${itemId}`, {
            method: "POST",
        })
        .then(res => {
            if(res.ok) {
                
                const categoryBlock = row.closest(".category-block");

                row.remove(); // 削除成功したらDOMから消す

                if (categoryBlock &&
                    categoryBlock.querySelectorAll(".item-card").length === 0) {
                    categoryBlock.remove();
                }
            } else {
                alert("削除できませんでした");
            }
        })
        .catch(() => alert("通信エラー"));
        })
    });


    let mysetMode = false;
    const modeBtn = document.getElementById("register-myset-mode");
    const submitBtn = document.getElementById("submit-myset-btn");
    const sideActions = document.querySelector(".side-actions");
    const cards = document.querySelectorAll(".item-card");
    const overlay = document.getElementById("overlay");
    const otherBtns = document.querySelectorAll(
        "#btn-show-mysets, #btn-add-custom-item, #btn-update-qty, #btn-reset-items, #btn-back"
    );

    modeBtn.addEventListener("click", () => {
        mysetMode = !mysetMode
        modeBtn.classList.toggle("mode-on", mysetMode);
        modeBtn.classList.toggle("mode-off", !mysetMode);
        sideActions.classList.toggle("mode-on"); // サイド全体にクラス追加

        submitBtn.classList.toggle("hidden", !mysetMode);

        overlay.classList.toggle("hidden", !mysetMode);

        otherBtns.forEach(btn => {
            btn.classList.toggle("hidden", mysetMode); 
        });

        document.body.classList.toggle("mode-on", mysetMode);

        // カード見た目切り替え
        cards.forEach(card => {
            card.classList.toggle("mode-on", mysetMode);

            // OFFになったら選択解除
            if (!mysetMode) {
                card.classList.remove("selected");
                card.querySelector(".select-for-myset").checked = false;
            }
        });
    });

    // ▼ カードクリックで選択トグル
    cards.forEach(card => {
        card.addEventListener("click", () => {
            if (!mysetMode) return;
            card.classList.toggle("selected");

            // 対応するチェックボックスも更新
            const checkbox = card.querySelector(".select-for-myset");
            checkbox.checked = card.classList.contains("selected");
        });
    });

    submitBtn.addEventListener("click", () => {
        const selectedIds = [...document.querySelectorAll(".select-for-myset:checked")].map(input => input.value);

        if(selectedIds.length === 0){
            alert("アイテムを選択してください");
            return;
        }

        const mysetName = prompt("マイセット名を入力してください");
        if(!mysetName) return;

        fetch("/myset/create", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                name: mysetName,
                item_ids: selectedIds,
                travel_id: {{ travel.id }}
            })
        })
        .then(res => {
            if(res.ok){
                alert("マイセットに登録しました");
                // チェックをリセット
                location.reload();
            } else {
                alert("登録に失敗しました");
            }
        })
        .catch(() => alert("通信エラー"));
    });
</script>

{% endblock %}